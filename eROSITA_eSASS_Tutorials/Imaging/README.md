# Scripts for eROSITA Imaging using the eSASS software and xmm-sas.

The tutorials and scripts are structured as follows:

## 2.1. [Image Creation](Imaging.py)
### Using the Imaging Script and Notebook

The `Imaging.py` script and the `021_Imaging_tutorial.ipynb` notebook process eROSITA data to generate images, exposure maps, and exposure-corrected images. Below are the steps to use the script and notebook:

#### Using the Imaging Script

- **Run the Imaging Script**:
    ```bash
    python Imaging.py <event_file> <output_dir> <band_min> <band_max> [--rgb] [--rgb_bands R_MIN R_MAX G_MIN G_MAX B_MIN B_MAX]
    ```

    - `<event_file>`: Input event file name.
    - `<output_dir>`: Output directory where the results will be saved.
    - `<band_min>`: Minimum energy band in eV (required if `--rgb` is not set).
    - `<band_max>`: Maximum energy band in eV (required if `--rgb` is not set).

- **Script Options**:
    - `--rgb`: Create RGB images using predefined or specified energy bands.
    - `--rgb_bands R_MIN R_MAX G_MIN G_MAX B_MIN B_MAX`: Energy bands for RGB image creation. If not provided, default bands (200-700 eV, 700-1100 eV, 1100-2300 eV) will be used.

- **Example Usage**:
    ```bash
    python Imaging.py event.fits output_dir 200 2000
    python Imaging.py event.fits output_dir --rgb --rgb_bands 200 700 700 1100 1100 2300
    ```

- **Script Description**:
    The script performs the following steps:
    - Creates an image using the specified energy band or RGB bands.
    - Generates an exposure map for the created image.
    - Creates an exposure-corrected image.

- **Functions**:
    - `run_evtool(input_name, output_name, emin, emax, gti_type='FLAREGTI', flag_type='0xe00fff30', pattern='15', telid='1 2 3 4 5 6 7', log_file=None)`: Runs the 'evtool' command to create an image from the event file.
    - `run_expmap(input_eventlist, input_image, output_name, emin, emax, log_file=None)`: Runs the 'expmap' command to generate an exposure map for the image.
    - `exp_corr(input_image, input_expmap, output_name)`: Creates an exposure-corrected image by dividing the counts image by the exposure map.

#### Using the Imaging Notebook

The [021_Imaging_tutorial.ipynb](021_Imaging_tutorial.ipynb) notebook provides a tutorial of the python script [Imaging.py](Imaging.py) to process the eROSITA data. It includes the following steps:

- **Creating Image and Exposure Map**: Use functions to create images and exposure maps.
- **Exposure Correction**: Generate exposure-corrected images.
- **Viewing the Image**: Visualize the images using interactive widgets.
- **RGB Image**: Create and visualize RGB images using predefined or specified energy bands.

For more detailed information, refer to the comments and documentation within the [Imaging.py](Imaging.py) script and the [021_Imaging_tutorial.ipynb](021_Imaging_tutorial.ipynb) notebook.

## 2.2. [Source Detection](source_detection.py)

### Using the Scripts and Notebooks for Source Detection

The `source_detection.py` script performs source detection on the generated images and creates cheese-mask files to mask out point sources for further analysis. 

#### Using the Source Detection Script

- **Run the Source Detection Script**:
    ```bash
    python source_detection.py <input_image> <input_expmap> <output_dir> <PS_size> [--pts_catalog <pts_catalog>]
    ```

    - `<input_image>`: Path to the input image file.
    - `<input_expmap>`: Path to the input exposure map file.
    - `<output_dir>`: Directory to save the output files.
    - `<PS_size>`: Point source extent size in arcmin. This value is used to create cheese masks around detected point sources.
    - `--pts_catalog`: (Optional) Path to the input catalog file. If not provided, the catalog generated by the pipeline will be used.

- **Script Description**:
    The script performs the following steps:
    - **ERMASK**: Creates a detection mask using the exposure map.
    - **ERBOX (local)**: Runs source detection in local mode to create an initial list of source positions.
    - **ERBACKMAP**: Generates a background map from a source-free image.
    - **ERBOX (map)**: Runs source detection in map mode using the background map.
    - **ERMLDET**: Identifies sources using a maximum likelihood method.
    - **CATPREP**: Prepares the final catalog of detected sources.
    - **Cheese Mask Creation**: Creates a cheese mask by masking out regions around detected point sources.

- **Output Files**:
    - `<output_dir>/detmask.fits`: Detection mask file.
    - `<output_dir>/boxlist_local.fits`: Initial list of source positions from local mode source detection.
    - `<output_dir>/BG_maps/bkg_map.fits`: Background map generated from a source-free image.
    - `<output_dir>/BG_maps/cheesemask_all.fits`: Cheese mask file masking out regions around all detected sources (Point Sources and Extended Sources).
    - `<output_dir>/boxlist_map.fits`: List of source positions from map mode source detection.
    - `<output_dir>/mllist.fits`: List of identified sources using a maximum likelihood method.
    - `<output_dir>/sourceimage.fits`: Source image file.
    - `<output_dir>/catalog.fits`: Final catalog of detected sources.
    - `<output_dir>/cheesemask_PS_<PS_size>arcmin.fits`: Cheese mask file masking out regions around detected point sources with the `PS_size` as the extent size.
    - `<output_dir>/Point_Sources_<PS_size>arcmin.reg`: Region file containing the point sources with the `PS_size` as the extent size.
    - `<output_dir>/process.log`: Log file containing the output of each step.

## 2.3. [Masking and Smoothing](masking_smooting.py)

The `masking_smooting.py` script handles smoothing of images and optionally masks out point sources based on a ds9 region file. By default, the script uses the cheese-mask file created during source detection.
#### Using the Masking and Smoothing Script

- **Run the Masking and Smoothing Script**:
    ```bash
    python masking_smooting.py <input_image> <input_expmap> <desired_snr> <cheesemask_file> [--cheesemask_regions <cheesemask_regions>] [--detmask_file <detmask_file>] [--new_cheesemask]
    ```

    - `<input_image>`: Path to the input image file.
    - `<input_expmap>`: Path to the input exposure map file.
    - `<desired_snr>`: Desired signal-to-noise ratio for asmooth.
    - `<cheesemask_file>`: Path to the cheese-mask file.
    **NOTE: If the following optional arguments are provided, the script will create a new cheese-mask from the ds9 region file.**
    - `--cheesemask_regions`: (Optional) Path to the cheese-mask ds9 format region file. Required for creating and working with a new cheese-mask.
    - `--detmask_file`: (Optional) Path to the detection mask file. Required for creating and working with a new cheese-mask from the ds9 region file.
    - `--new_cheesemask`: (Optional) Flag to create a new cheese-mask or overwrite the existing one. Default is False.

- **Script Description**:
    The script performs the following steps:
    - **OPTIONAL: Creating a Cheese Mask**: Masks out regions around the point sources in ds9 region file to create a source-free image. If the `--cheesemask_regions` and `--detmask_file` are provided, a new cheese-mask is created and used for further processing.
    ***NOTE:*** To perform the next steps, a new `run_asmooth.sh` script is created with all the necessary parameters. This is necessary to run the `asmooth` command, as it requires sourcing the xmm-sas environment. This script is created in the same directory as the `masking_smooting.py` script. 
    - **Masking the image and exposure map**: Masks out the regions around the point sources using the cheese-mask by multiplying the image and exposure map with the cheese-mask.
    - **Running ASMOOTH**: Smooths the masked image to enhance the signal-to-noise ratio and fill in the masked regions.

- **Example Usage**:
    ```bash
    python masking_smooting.py image.fits expmap.fits 30 cheesemask.fits
    python masking_smooting.py image.fits expmap.fits 30 cheesemask.fits --cheesemask_regions regions.reg --detmask_file detmask.fits --new_cheesemask
    ```

### Output Files

- `<input_image>_masked.fits`: Masked image file.
- `<input_expmap>_masked.fits`: Masked exposure map file.
- `<input_image>_asmooth.fits`: Smoothed image file.
- `<cheesemask_file>_new.fits`: New cheese-mask file if `--new_cheesemask` is set.
- `<cheesemask_file_dir>/process.log`: Log file containing the output of asmooth task. The logs are appended in the same file as the previous step of source detection.

#### The Point source removal Notebook
The [022_PTS_removal.ipynb](022_PTS_removal.ipynb) notebook provides a tutorial on using the [Source Detection](source_detection.py) and [Masking and Smoothing](masking_smooting.py) script to perform source detection and smoothing on the generated images.



